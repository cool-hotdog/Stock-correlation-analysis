# 股票收益率相关性分析说明（README）

本项目用于对一组股票在同一时间区间内的**日收益率**进行相关性分析，并以**相关性矩阵热力图**的方式可视化，帮助你快速判断“哪些股票的波动更像”。

> 重要提示：相关性只描述历史上的“同涨同跌程度”，不代表因果关系，也不构成任何投资建议。

---

## 1. 分析原理（你看到的数值/颜色到底是什么）

### 1.1 日收益率的定义

本项目统一使用 `data/get_stock_data.py` 中的口径计算日收益率：

$$ r_t = \frac{close_t}{pre\_close_t} - 1 $$

其中：
- `close_t`：当日收盘价
- `pre_close_t`：昨收价

选择 `pre_close` 的好处是避免手动 `shift` 带来的边界问题，也与 Tushare 日线接口口径更一致。

### 1.2 相关性系数：Pearson / Spearman / 综合权重

你可能会用到三个脚本（见下文“脚本与产出”），它们对应不同的相关性定义：

- **Pearson（皮尔逊）相关系数**：衡量两个序列的线性相关程度（对“线性关系”敏感）。
	- 取值范围 $[-1, 1]$，越接近 1 表示越同涨同跌。
- **Spearman（斯皮尔曼）相关系数**：先把数据转为“排名”，再计算相关性。
	- 对极端值更稳健，更关注“方向/排序的一致性”。
- **综合相关系数（加权组合）**：

$$ corr_{combined} = 0.7\cdot corr_{pearson} + 0.3\cdot corr_{spearman} $$

这是一种经验权重：用 Pearson 抓主要线性关系，用 Spearman 提供一定的鲁棒性；你也可以按需要调整权重。

### 1.3 交易日对齐与缺失值处理

相关性必须建立在“同一交易日”的对齐基础上。一般流程是：

1. 每只股票得到一条以 `trade_date` 为索引的 `daily_return` 序列。
2. 把多只股票拼成同一张表（列是股票，行是交易日）。

项目中有两种常见处理方式：

- **两只股票相关性**（`pearson_with_2stocks.py` / `stock_data_analysis.py`）：
	- 做内连接（只保留共同交易日），避免缺失值影响。
- **30只股票相关性矩阵**（`pearson_with_30stocks.py` / `pearson_with_spearman.py`）：
	- 当前实现使用 `fillna(0)` 进行缺失值填充后再算相关性。
	- 注意：这会把“缺失的那天”当作“收益率为 0”，可能引入偏差（见“注意事项”中的建议）。

---

## 2. 项目结构与脚本说明

### 2.1 数据获取模块（统一入口）

- `data/get_stock_data.py`
	- `get_stock_return_daily(ts_code, start_date, end_date, token)`：获取单只股票日收益率。
	- Token 优先级：函数参数 `token` > 环境变量 `TUSHARE_TOKEN` > 文件内 `MY_TOKEN`。

> 更详细的数据接口说明见：`data/README_data_interface.md`

### 2.2 分析脚本（按需求选择运行）

- `pearson_with_2stocks.py` / `stock_data_analysis.py`
	- 输入 2 只股票代码，计算共同交易日的 Pearson 相关系数，并输出 p-value、共同交易日数量。
- `pearson_with_30stocks.py`
	- 输入约 30 只股票代码，输出 Pearson 相关矩阵并生成热力图、Top5 相关对。
- `pearson_with_spearman.py`
	- 输入约 30 只股票代码，可用于 Spearman/综合相关的分析与可视化（以文件内实现为准）。

---

## 3. 使用方法

### 3.1 安装依赖

建议使用 Python 3，并安装：
- `tushare`
- `pandas`
- `scipy`
- `matplotlib`
- `seaborn`
- `numpy`

在 macOS / zsh 下可使用：

```bash
python3 -m pip install tushare pandas scipy matplotlib seaborn numpy
```

### 3.2 配置 Tushare Token（推荐用环境变量）

```bash
export TUSHARE_TOKEN="你的token"
```

你也可以直接修改 `data/get_stock_data.py` 里的 `MY_TOKEN`，但不建议把 Token 写进仓库（容易泄露）。

### 3.3 运行

以 30 支股票相关分析为例：

```bash
python3 pearson_with_30stocks.py
```

按照提示输入股票代码（用空格分隔），注意格式必须带后缀：
- 沪市：`.SH`
- 深市：`.SZ`

---

## 4. 结果如何解读

### 4.1 相关性矩阵热力图

热力图的每一个格子对应“一对股票”的相关系数（行股票 vs 列股票）。常见脚本会用颜色深浅表示强弱，并在格子里标出数值。

**数值怎么理解**（以 Pearson/Spearman 为例，范围都是 $[-1, 1]$）：

- 系数接近 **1**：两只股票收益率同向波动明显（同涨同跌）。
- 系数接近 **0**：相关性弱（同涨同跌不明显，或关系不稳定/非线性）。
- 系数接近 **-1**：收益率呈反向联动（一个涨另一个更可能跌）。

**图上结构怎么读**：

- **对角线（自己和自己）恒等于 1**：因为任意序列与自身完全相关。
- **矩阵是对称的**：$corr(A,B)=corr(B,A)$，所以上三角和下三角是镜像。
- **看“成块的红色/暖色区域”**：
	- 往往代表同一行业/同一主题/同样风格（例如大盘权重、周期、成长等）的股票在该窗口期里“涨跌更同步”。
	- 如果出现明显的“块状结构”，说明你的 30 支股票里可能天然分成了几个相互相关更强的子群。
- **零散的高相关**：可能是两只股票业务高度相近、指数成分重叠、或同一事件驱动（但也可能是短期偶然）。

**颜色与数值**：不同脚本可能用不同色盘（例如高相关是红色、低相关是绿色），最终以格子里的数值为准。

**警惕“看起来很红/很绿但不可信”的情况**：

- **样本量过小**：交易日重叠太少时，相关系数会非常不稳定（两只股票脚本里会输出 `common_trading_days` 供你判断）。
- **缺失值处理影响**：如果使用了 `fillna(0)`，停牌/缺数会被当作“收益率 0”，可能让相关性被稀释或产生人为结构。
- **极端行情窗口**：例如单边大涨/大跌阶段，许多股票会“被动一起动”，相关性普遍偏高，不代表长期关系。

**一个实用的读图方式（快速筛选）**：

1. 先找 0.7 以上的高相关（可能高度同质化）。
2. 再看 0.2 左右或更低的低相关（可能更分散）。
3. 对你关注的股票，横向/纵向扫一遍整行整列，立刻知道它和谁“最像”。

### 4.2 Top5 相关股票对

脚本会在控制台打印相关性最高的若干股票对，便于快速定位“高度同质化”的股票组合。

---

## 5. 使用注意事项（很重要）

1. **相关性不是稳定不变的**：窗口期不同（2020 vs 2025）、市场阶段不同（牛/熊/震荡）都会显著影响结果。建议你把 `start_date/end_date` 参数显式传入，做多窗口对比。
2. **缺失值填充会影响相关性**：
	 - 当前 30 股票脚本使用 `fillna(0)`，在停牌/缺少数据时可能引入偏差。
	 - 更严谨的做法通常是：按共同交易日对齐后再算，或使用前向填充/直接丢弃缺失行（取决于你的研究目的）。
3. **Tushare 调用频率限制**：一次性拉取 30 支股票整年数据会较慢，且可能触发频控。建议先用少量股票小样本跑通流程。
4. **股票代码必须带后缀**：例如 `600519.SH`、`000001.SZ`。
5. **字体/中文乱码**：脚本里已做字体候选自动适配；如果仍乱码，可在字体候选列表中加入你本机已安装字体名。
6. **输出文件路径**：热力图会保存到当前工作目录；如果目录无写权限会失败，换到可写目录或用绝对路径指定保存位置。

---

## 6. 常见问题排查

- 运行时报 Token 错误：
	- 确认已设置 `TUSHARE_TOKEN`，或 `data/get_stock_data.py` 里的 `MY_TOKEN` 已正确填写。
- 获取数据为空：
	- 通常是股票代码没带 `.SH/.SZ`，或代码不正确。
- 热力图生成失败：
	- 多数是缺少依赖（`matplotlib/seaborn`）或无写权限。

